# GitHub Actions workflow for running expensive legacy ITC tests
# Triggers when:
# - PR modifies itc/service/ocslib/ (OCS JAR files or build-info.json)
# - PR modifies itc/legacy-tests/ (test suite itself)
# - PR is labeled with 'legacy-tests' (manual override)
# - Scheduled daily at 2 AM UTC
# - Manually triggered via workflow_dispatch

name: Legacy ITC Tests

on:
  pull_request:
    types: [labeled, opened, synchronize, reopened]
    paths:
      - 'itc/service/ocslib/**'
      - 'itc/legacy-tests/**'
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  legacy-tests:
    name: Legacy ITC Tests
    # Run on schedule, manual trigger, path changes, or legacy-tests label
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'pull_request'
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code with LFS
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache SBT
        uses: actions/cache@v4
        with:
          path: |
            ~/.sbt
            ~/.ivy2/cache
            ~/.coursier
          key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt', '**/project/build.properties', '**/project/plugins.sbt') }}
          restore-keys: |
            ${{ runner.os }}-sbt-

      - name: Run Legacy ITC Tests
        env:
          RUN_LEGACY_TESTS: true
        run: sbt -v -J-Xmx6g itcLegacyTests/test
